# çˆ¶å­ç»„ä»¶é€šè®¯

## çˆ¶ä¼ å­

çˆ¶ä¼ å­ï¼Œä¾æ—§éœ€è¦åœ¨å­ç»„ä»¶æ ‡ç­¾ä¸­ç»‘å®šå±æ€§è¿›è¡Œpropsçš„ä¼ é€’ï¼Œå­ç»„ä»¶ä¹Ÿä¾ç„¶è¦é€šè¿‡é…ç½®propsé€‰é¡¹æ¥è¿›è¡Œæ¥æ”¶ï¼Œæœ€å…³é”®çš„æ˜¯å¦‚ä½•åœ¨setupä¸­è¿›è¡Œè®¿é—®ã€‚

ä¹‹å‰æˆ‘ä»¬äº†è§£è¿‡setupæ¥æ”¶ä¸¤ä¸ªå‚æ•°

* props
* context

æ²¡é”™ï¼Œå°±æ˜¯é€šè¿‡propså‚æ•°è®¿é—®çˆ¶ç»„ä»¶ä¼ å…¥çš„æ•°æ®ï¼Œä½†åœ¨ä½¿ç”¨æ—¶ï¼Œæœ‰ä¸€äº›æ³¨æ„ç‚¹ï¼š

* ç”±äºpropsæ˜¯ä¸€ä¸ªProxyå¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è¿›è¡Œè§£æ„ã€‚
  * å¯ä»¥ä½¿ç”¨toRefsè½¬åŒ–åè¿›è¡Œé€ä¸€è§£æ„ã€‚
* ç¦æ­¢åœ¨å­ç»„ä»¶ä¸­æ›´æ”¹çˆ¶ç»„ä»¶ä¼ å…¥çš„propsï¼Œå› ä¸ºå¦‚æœpropsä¸­çš„çŠ¶æ€æ˜¯`å¼•ç”¨ç±»å‹æ•°æ®`ï¼Œåˆ™ä¼šç›´æ¥å½±å“çˆ¶ç»„ä»¶ä»¥åŠå…¶å®ƒä¾èµ–è¯¥propsçš„å­ç»„ä»¶ã€‚

è¿™é‡Œç”¨ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹æ¥åŠ æ·±å°è±¡

**App.vue**

```
<template>
  <main>
    <h2>{{ title }}</h2>
    <Child :list="list" />
  </main>
</template>
<script>
  import { defineComponent, reactive, toRefs } from "vue";
  import Child from "./Child.vue";
  export default defineComponent({
    components: {
      Child,
    },
    setup() {
      const state = reactive({
        title: "App",
        list: ["æ–°é—»", "å¨±ä¹", "ç§‘æŠ€"],
      });

      return {
        ...toRefs(state),
      };
    },
  });
</script>
```

**Child.vue**

```
<template>
  <div>
    <h3>{{ title }}</h3>
    <hr />
    <p>çˆ¶ç»„ä»¶ä¼ å…¥çš„props</p>
    <ul>
      <li v-for="val in parent.list" :key="val">{{ val }}</li>
    </ul>
  </div>
</template>
<script>
  import { defineComponent, reactive, toRefs } from "vue";

  export default defineComponent({
    props: {
      list: {
        type: Array,
        default: () => [],
      },
    },
    setup(props) {
      const state = reactive({
        title: "æˆ‘æ˜¯childç»„ä»¶",
      });
      console.log(props);
      /*
        ç”±äºpropsæ˜¯ä¸€ä¸ªProxyå¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è¿›è¡Œè§£æ„ï¼Œ
        å¯ä»¥ä½¿ç”¨toRefsè½¬åŒ–åè¿›è¡Œé€ä¸€è§£æ„ã€‚
      */
      // let { list } = props;
      let { list } = toRefs(props);

      console.log(list.value);
      const parent = {
        list: list.value,
      };

      return {
        ...toRefs(state),
        parent,
      };
    },
  });
</script>
```

## å­ä¼ çˆ¶

åœ¨Vue2.xä¸­æˆ‘ä»¬éœ€è¦é€šè¿‡`this.$emit`å®Œæˆå­ä¼ çˆ¶ï¼Œä½†Vue3ä¸­çš„`setup`ä¸èƒ½è®¿é—®`this`ï¼Œé‚£è¦æ€ä¹ˆå®ç°å‘¢ï¼Ÿ

* é€šè¿‡setupçš„ç¬¬äºŒä¸ªå‚æ•°`context`è¿›è¡Œè®¿é—®ã€‚

  * **contextåŒ…å«å“ªäº›å¯è®¿é—®é€‰é¡¹å‘¢ï¼Ÿ**

    æ‰§è¡Œ `setup` æ—¶ï¼Œç»„ä»¶å®ä¾‹å°šæœªè¢«åˆ›å»ºã€‚å› æ­¤ï¼Œä½ åªèƒ½è®¿é—®ä»¥ä¸‹ propertyï¼š

    - `props`
    - `attrs`
    - `slots`
    - `emit`

    æ¢å¥è¯è¯´ï¼Œä½ **å°†æ— æ³•è®¿é—®**ä»¥ä¸‹ç»„ä»¶é€‰é¡¹ï¼š

    - `data`
    - `computed`
    - `methods`

* ç”±äºcontextæ•°æ®ä¸æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥å¯ä»¥è§£æ„æƒ³è¦ä½¿ç”¨çš„åŠŸèƒ½å‡½æ•°ã€‚

è¿™é‡Œç”¨ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹æ¥åŠ æ·±å°è±¡ğŸ‘‡

**App.vue**

```
<template>
  <main>
    <h2>{{ title }}</h2>
    <Child v-show="isShow" @hidden="hiddenChild" />
  </main>
</template>
<script>
  import { defineComponent, reactive, toRefs } from "vue";
  import Child from "./Child.vue";
  export default defineComponent({
    components: {
      Child,
    },
    setup() {
      const state = reactive({
        title: "App",
        isShow: true,
      });

      const hiddenChild = (isShow) => {
        state.isShow = isShow;
      };
      return {
        ...toRefs(state),
        hiddenChild,
      };
    },
  });
</script>
```

**Child.vue**

```
<template>
  <div>
    <h3>{{ title }}</h3>
    <hr />
    <button @click="hidden">ç‚¹æˆ‘éšè—</button>
  </div>
</template>
<script>
  import { defineComponent, reactive, toRefs } from "vue";

  export default defineComponent({
    setup(props, { emit }) {
      const state = reactive({
        title: "æˆ‘æ˜¯childç»„ä»¶",
      });

      const hidden = () => {
        emit("hidden", false);
      };
      return {
        ...toRefs(state),
        hidden,
      };
    },
  });
</script>
```

# provide&inject

å‰é¢è®²åˆ°äº†çˆ¶å­ç»„ä»¶çš„é€šè®¯ï¼Œä½†å¦‚æœcomponentå±‚çº§åµŒå¥—å¾ˆæ·±ï¼Œå°±æ„å‘³ç€è¦é€å±‚è¿›è¡Œstateçš„ä¼ é€’ï¼Œè¿™ä¼šæœ‰ä¸€äº›ä¸å¥½çš„å½±å“ï¼š

* å®ç°è¿‡ç¨‹ç¹çã€‚
* è¿˜ä¼šå¯¼è‡´ä¸­é—´ç»„ä»¶è¢«è¿«æ¥æ”¶state
* ä»£ç è‡ƒè‚¿

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`provide`ã€`inject`è¿›è¡Œè§£å†³ï¼Œå…¶ä¸»è¦ä½¿ç”¨æ€è·¯ä¸ºï¼š

* `provide`ã€`inject`äºŒè€…éƒ½æ˜¯vueä¸­çš„åŠŸèƒ½å‡½æ•°ï¼Œä½¿ç”¨å‰è¦å…ˆè¿›è¡Œå¯¼å…¥ã€‚

* `provide`å¯ä»¥å°†çˆ¶ç»„ä»¶ä¸­çš„çŠ¶æ€å…±äº«ç»™åä»£ç»„ä»¶ï¼Œè¯¥çŠ¶æ€å¯ä»¥æ˜¯æ™®é€šå˜é‡ã€æ–¹æ³•ã€‚
* åä»£ç»„ä»¶é€šè¿‡`inject`å°†`provide`å…±äº«çš„çŠ¶æ€æ³¨å…¥ã€‚

### provide

```
provide("stateName",state)
```

* stateName
  * å®šä¹‰å…±äº«çŠ¶æ€çš„åç§°ï¼Œåä»£ç»„ä»¶å°±æ˜¯é€šè¿‡è¯¥åç§°è®¿é—®å¯¹åº”çš„çŠ¶æ€
* state
  * è¦å…±äº«çš„stateï¼Œå¯ä»¥æ˜¯æ™®é€šå˜é‡ï¼Œä¹Ÿå¯æ˜¯æ–¹æ³•ã€‚

### inject

```
const state = inject("stateName",defaultValue)
```

* ä¼ å…¥stateNameå³å¯è®¿é—®å¯¹åº”çš„å…±äº«çŠ¶æ€ï¼Œå¯é€šè¿‡ç¬¬äºŒä¸ªå¯é€‰å‚æ•°å®šä¹‰é»˜è®¤å€¼ã€‚
* è¿™äº›å…±äº«çŠ¶æ€æ˜¯**åªè¯»çš„**ï¼Œå¦‚æœå°è¯•æ›´æ”¹ï¼Œä¼šæŠ¥é”™ã€‚

### æ¡ˆä¾‹ä½“éªŒ

å…±æœ‰ä¸‰ä¸ªç»„ä»¶ï¼Œå…¶åµŒå¥—å…³ç³»ä¸ºï¼š

* App
  * Child
    * Grandson

é€šè¿‡`provide&inject`è®©Appä¸Grandsonç›´æ¥é€šè®¯ï¼Œå½“åœ¨Grandsonä¸­ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œé€šè¿‡Appçš„äº‹ä»¶è®©Childéšè—ã€‚

**App.vue**

```
<template>
  <main>
    <h2>{{ title }}</h2>
    <Child v-show="isShow" />
  </main>
</template>
<script>
  import { defineComponent, reactive, toRefs, provide } from "vue";
  import Child from "./Child.vue";

  export default defineComponent({
    components: {
      Child,
    },
    setup() {
      const state = reactive({
        title: "App",
        isShow: true,
      });

      const changeIsShow = (isShow) => {
        console.log(isShow);
        state.isShow = isShow;
      };
      //å…±äº«çŠ¶æ€
      provide("changeIsShow", changeIsShow);
      provide("title", state.title);
      return {
        ...toRefs(state),
      };
    },
  });
</script>
<style scoped>
  main {
    background: pink;
  }
</style>
```

**Child.vue**

```
<template>
  <div>
    <h3>{{ title }}</h3>
    <hr />
    <grandson />
  </div>
</template>
<script>
  import { defineComponent, reactive, toRefs } from "vue";
  import Grandson from "./Grandson.vue";
  export default defineComponent({
    components: {
      Grandson,
    },
    setup(props, { emit }) {
      const state = reactive({
        title: "æˆ‘æ˜¯childç»„ä»¶",
      });

      return {
        ...toRefs(state),
      };
    },
  });
</script>
<style scoped>
  div {
    background: yellowgreen;
  }
</style>
```

**Grandson.vue**

```
<template>
  <div id="Grandson">
    <h3>{{ title }}</h3>
    <hr />
    <button @click="hidden">ç‚¹æˆ‘éšè—</button>
  </div>
</template>
<script>
  import { defineComponent, reactive, toRefs, inject } from "vue";

  export default defineComponent({
    setup(props) {
      const state = reactive({
        title: "æˆ‘æ˜¯Grandsonç»„ä»¶",
      });
			//æ³¨å…¥å…±äº«å˜é‡
      const hidden = inject("changeIsShow").bind(null,false);
      //æ‰“å°ç»“æœå¯çŸ¥ï¼Œå°±æ˜¯Appç»„ä»¶å…±äº«çš„å‡½æ•°
      console.log(hidden);
      
      return {
        ...toRefs(state),
        hidden,
      };
    },
  });
</script>
<style scoped>
  #Grandson {
    background: #e67e22;
    margin: 5px;
  }
</style>
```

### ä½¿ç”¨æ³¨æ„é¡¹

`provide&inject`åœ¨ä½¿ç”¨æ—¶æœ‰ä¸€äº›æ³¨æ„é¡¹ï¼Œè¿™é‡Œå…ˆæ±‡æ€»ä¸€ä¸‹ï¼š

1. `provide`å…±äº«çš„çŠ¶æ€æ˜¯**åªè¯»çš„**ï¼Œå¦‚æœåä»£ç»„ä»¶ä½¿ç”¨`inject`æ¥æ”¶åè¿›è¡Œæ›´æ”¹ä¼šæŠ¥é”™ã€‚
2. ä¸¤è€…éƒ½**åªèƒ½**åœ¨å½“å‰æ´»åŠ¨å®ä¾‹çš„ `setup()` æœŸé—´è°ƒç”¨

---

**è§£æ1** 

â€‹	æ‹¿ä¸Šæ–‡æ¡ˆä¾‹æ¥è¯´ï¼Œåœ¨åä»£ç»„ä»¶å®šä¹‰`hidden`å˜é‡ï¼Œæ¥æ”¶`changeIsShow`å…±äº«æ–¹æ³•ã€‚ä½†å¦‚æœåœ¨åæœŸå¯¹hiddenè¿›è¡Œæ›´æ”¹ï¼Œä¼šæŠ¥é”™ï¼Œå‘ŠçŸ¥ä½ è¿™äº›çŠ¶æ€æ˜¯`readonly`ã€‚

**è§£æ2**

â€‹	`provide&inject`**åªèƒ½**åœ¨å½“å‰æ´»åŠ¨å®ä¾‹çš„ `setup()` æœŸé—´è°ƒç”¨ã€‚

è¿™ä¸ªç‰¹ç‚¹å¾ˆé‡è¦ï¼Œä¾‹å¦‚ï¼šåœ¨åä»£ç»„ä»¶ç‚¹å‡»æŒ‰é’®åï¼Œé™¤äº†æ‰§è¡Œå…±äº«æ–¹æ³•`changeIsShow`ï¼Œæˆ‘è¿˜æƒ³è¿›è¡Œä¸€äº›æ“ä½œç”¨äºç»´æŠ¤è¯¥åä»£ç»„ä»¶ï¼Œæ­¤æ—¶ä½ å¯èƒ½ä¼šå†™å‡ºä¸‹ä¾‹ä»£ç ï¼š

```
const hidden = () => {
	//å…±äº«æ–¹æ³•æ‰§è¡Œ
  inject("changeIsShow").call(null, false);
  //å…¶ä»–æ“ä½œ
  â€¦â€¦
};
```

ä½†å¾ˆé—æ†¾ï¼Œè¿™ç§æ“ä½œä¸èƒ½å¥æ•ˆï¼ŒåŸå› å°±æ˜¯`provide&inject`**åªèƒ½**åœ¨å½“å‰æ´»åŠ¨å®ä¾‹çš„ `setup()` æœŸé—´è°ƒç”¨ã€‚å°†å…¶å°è£…åˆ°äº‹ä»¶ä¸­ä¹Ÿä¸å¯ä»¥ï¼Œå› ä¸ºå½“ä¸è§†å›¾äº¤äº’è§¦å‘è¯¥äº‹ä»¶æ—¶ï¼Œå·²ç»æ˜¯æŒ‚è½½åäº†ã€‚

ä¸è¿‡æˆ‘ä»¬å¯ä»¥å°†å…¶ä»–æ“ä½œéƒ¨åˆ†æŠ½ç¦»åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œç„¶åä¾¦å¬å¤šä¸ª`click`äº‹ä»¶å³å¯ã€‚

* å„ä¸ªäº‹ä»¶å¿…é¡»æ˜¯**å‡½æ•°è°ƒç”¨å½¢å¼**ï¼Œè¿™å°±æ„å‘³ç€**å‚æ•°ä¼ é€’**è¦åœ¨templateä¸­å®Œæˆã€‚
* å„ä¸ªäº‹ä»¶ä¹‹é—´ä½¿ç”¨ `;` éš”å¼€ã€‚

```
<template>
â€¦â€¦
    <button
      @click="
        hidden(false);
        testEvent();
      "
    >
      ç‚¹æˆ‘éšè—
    </button>
â€¦â€¦
</template>
<script>
  import { defineComponent, reactive, toRefs, inject } from "vue";

  export default defineComponent({
    setup(props, { emit }) {
      const state = reactive({
        title: "æˆ‘æ˜¯Grandsonç»„ä»¶",
      });

      const hidden = inject("changeIsShow");
      const title = inject("title", "Ashuntefannao");

      const testEvent = () => {
        console.log(title);
      };

      return {
        ...toRefs(state),
        hidden,
        testEvent,
      };
    },
  });
</script>
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸šåŠ¡æ¯”è¾ƒå¤æ‚æ—¶ï¼Œ`provide&inject`ä½¿ç”¨è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨`Vuex`ï¼Œä¹Ÿå¯ä½¿ç”¨ä¸‹æ–‡è®²è§£åˆ°çš„`mitt`æ’ä»¶ï¼Œå®ç°Vue2.xä¸­çš„äº‹ä»¶æ€»çº¿ã€‚

# tiny-emitter/mittå®ç°äº‹ä»¶æ€»çº¿

åœ¨Vue2.xä¸­æˆ‘ä»¬å¦‚æœè¦å®ç°ä¸€ä¸ªäº‹ä»¶æ€»çº¿éå¸¸ç®€å•ï¼š

```
import Vue from "vue"
Vue.prototype.$bus = new Vue();
```

åæœŸåœ¨ç»„ä»¶ä¸­ä½¿ç”¨`$onã€$emit`è¿›è¡Œäº‹ä»¶çš„ä¾¦å¬å’Œå‘å°„ã€‚

ä½†åœ¨Vue3ä¸­ï¼Œä¸èƒ½ç›´æ¥åƒVue2.xä¸€æ ·ç®€å•çš„å®ç°ï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š

1. `setup`ä¸­ä¸èƒ½è®¿é—®`this`

2. å®ä¾‹ä¸­å®Œå…¨ç§»é™¤äº† `$on`ã€`$off` å’Œ `$once` æ–¹æ³•ã€‚

   é€šè¿‡Vue3çš„`createApp`åˆ›å»ºå®ä¾‹ï¼Œæ‰“å°ç»“æœä¹Ÿå¯çœ‹åˆ°ï¼Œç§»é™¤äº†ä¸Šè¿°API

   `$emit` ä»ç„¶åŒ…å«äºç°æœ‰çš„ API ä¸­ï¼Œå› ä¸ºå®ƒç”¨äºè§¦å‘ç”±çˆ¶ç»„ä»¶å£°æ˜å¼æ·»åŠ çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚

---

Event bus æ¨¡å¼å¯ä»¥è¢«æ›¿æ¢ä¸ºå®ç°äº†äº‹ä»¶è§¦å‘å™¨æ¥å£çš„å¤–éƒ¨åº“ï¼Œä¾‹å¦‚ [mitt](https://github.com/developit/mitt) æˆ– [tiny-emitter](https://github.com/scottcorgan/tiny-emitter)ã€‚

ç¤ºä¾‹:

```
tiny-emitter
```

```
// eventBus.js
import emitter from 'tiny-emitter/instance'

export default {
  $on: (...args) => emitter.on(...args),
  $once: (...args) => emitter.once(...args),
  $off: (...args) => emitter.off(...args),
  $emit: (...args) => emitter.emit(...args),
}
```

å®ƒæä¾›äº†ä¸ Vue 2 ç›¸åŒçš„äº‹ä»¶è§¦å‘å™¨ APIã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨[mitt](https://github.com/developit/mitt)ï¼Œåªä¸è¿‡å…¶æä¾›çš„APIæ²¡æœ‰å®Œå…¨ä¸Vue2.xä¿æŒä¸€è‡´ï¼š

- mitt
- all
- on
- off
- emit

